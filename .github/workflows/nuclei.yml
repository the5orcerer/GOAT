name: Security Scanning Pipeline

on:
  workflow_dispatch: 
    inputs: 
      file_name:
        required: true
        type: string
        description: "Input file name"
      command:
        required: true
        type: string
        description: "Command to execute"
      notification_mode:
        required: false
        type: choice
        default: "line"
        description: "Notification mode"
        options:
          - line
          - bulk
      bulk_filename:
        required: false
        type: string
        default:  "results.txt"
        description: "Output filename for bulk mode"

jobs:
  scan: 
    runs-on: ubuntu-latest
    
    steps:
      - uses:  actions/checkout@v4
          
      - name: Cache tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path:  ~/tools
          key: pdtools-v2-${{ runner.os }}
          
      - name: Install tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/tools && cd ~/tools
          
          # Download ProjectDiscovery tools
          for tool in "subfinder:2.8.0" "httpx:1.7.1" "nuclei:3.4.10" "katana:1.2.1" "naabu:2.3.1" "alterx:0.0.4"; do
            name=${tool%:*}
            ver=${tool#*:}
            wget -q "https://github.com/projectdiscovery/$name/releases/download/v${ver}/${name}_${ver}_linux_amd64.zip"
            unzip -o -q "${name}_${ver}_linux_amd64.zip"
            rm "${name}_${ver}_linux_amd64.zip"
          done

          # Download notify separately
          wget -q "https://github.com/projectdiscovery/notify/releases/download/v1.0.7/notify_1.0.7_linux_amd64.zip"
          unzip -o -q notify_1.0.7_linux_amd64.zip
          rm notify_1.0.7_linux_amd64.zip
          
          chmod +x *
          echo "Tools installed"
          
      - name: Setup PATH
        run: |
          echo "$HOME/tools" >> $GITHUB_PATH
          ~/tools/subfinder -version
          ~/tools/httpx -version
          ~/tools/nuclei -version
          ~/tools/katana -version
          ~/tools/naabu -version
          ~/tools/alterx -version
          ~/tools/notify -version
          
      - name: Cache templates
        id: cache-templates
        uses: actions/cache@v4
        with:
          path: nuclei-templates
          key: nuclei-templates-${{ github.run_id }}
          restore-keys: nuclei-templates-
          
      - name:  Clone templates
        if: steps.cache-templates.outputs.cache-hit != 'true'
        run: git clone --depth 1 https://github.com/projectdiscovery/nuclei-templates.git
          
      - name: Setup notify
        env:
          TELEGRAM_API_KEY: ${{ secrets.TELEGRAM_API_KEY }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat > notify.yml <<EOF
          telegram:
            - id: "tel"
              telegram_api_key: "$TELEGRAM_API_KEY"
              telegram_chat_id: "$TELEGRAM_CHAT_ID"
              telegram_format:  "{{data}}"
              telegram_parsemode: "Markdown"
          EOF
          
      - name:  Verify input
        run: |
          [[ -f "upload/${{ inputs.file_name }}" ]] || {
            echo "Error: File not found: upload/${{ inputs.file_name }}"
            ls -la upload/ 2>/dev/null || echo "upload/ directory missing"
            exit 1
          }
          echo "Input file: upload/${{ inputs.file_name }} ($(wc -l < upload/${{ inputs.file_name }}) lines)"
          
      - name:  Execute scan
        run: |
          FILE="upload/${{ inputs.file_name }}"
          CMD="${{ inputs.command }}"
          MODE="${{ inputs.notification_mode }}"
          BULK="${{ inputs.bulk_filename }}"
          
          echo "Starting scan: $(date)"
          
          if [[ "$MODE" == "bulk" ]]; then
            cat "$FILE" | eval "$CMD" > "$BULK" && {
              [[ -s "$BULK" ]] && {
                echo "Results: $(wc -l < $BULK) lines"
                notify -pc notify.yml -silent -data "$BULK" || echo "Notify failed"
              } || echo "ℹ️ No results" | notify -pc notify.yml -silent
            } || {
              echo "❌ Scan failed" | notify -pc notify.yml -silent
              exit 1
            }
          else
            cat "$FILE" | eval "$CMD" | notify -pc notify.yml -silent || {
              echo "❌ Scan failed" | notify -pc notify.yml -silent
              exit 1
            }
          fi
          
          echo "Completed: $(date)"
          
      - name: Upload results
        if: inputs.notification_mode == 'bulk'
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: ${{ inputs.bulk_filename }}
          retention-days: 7
          
      - name: Cleanup
        if: always()
        run: |
          rm -f notify.yml
          rm -f ${{ inputs.bulk_filename }} 2>/dev/null || true
          rm -rf nuclei-templates
